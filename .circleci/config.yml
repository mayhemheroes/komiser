version: 2.1
jobs:
  build_frontend:
    docker:
      - image: circleci/node:14.15-stretch-browsers
    working_directory: ~/komiser
    resource_class: large
    steps:
      - checkout
      - restore_cache:
          key: node-modules-{{checksum "dashboard/package.json"}}
      - run:
          name: Install dependencies
          command: cd dashboard && npm install
      - save_cache:
          key: node-modules-{{checksum "dashboard/package.json"}}
          paths:
            - dashboard/node_modules
      - run:
          name: Build artifact
          command: cd dashboard && npm run build
      - persist_to_workspace:
          root: dashboard
          paths:
            - dist
  build_cli:
    docker:
      - image: golang:1.18.3
    working_directory: /go/src/github.com/mlabouardy/komiser
    resource_class: large
    steps:
      - checkout
      - attach_workspace:
          at: /tmp/dashboard
      - run:
          name: Install dependencies
          command: |
            go mod download
      - run:
          name: Install go-bin-data
          command: |
           go install github.com/go-bindata/go-bindata/...
           go install github.com/elazarl/go-bindata-assetfs/...
      - run:
         name: Fix path
         command: mv /tmp/dashboard/dist .
      - run:
         name: Create assets
         command: go-bindata-assetfs -o template.go dist/...
      - run:
         name: Install gox
         command: go install github.com/mitchellh/gox@latest
      - run:
         name: Build binary
         no_output_timeout: 20m
         command: |
            gox -osarch="linux/amd64"
            gox -osarch="windows/amd64" 
            gox -osarch="darwin/amd64"
      - run:
         name: Install AWS CLI
         command: |
          apt-get update
          apt-get install -y awscli
          chmod +x komiser_windows_amd64.exe komiser_darwin_amd64 komiser_linux_amd64
      - run:
          name: Push Linux binary
          command: aws s3 cp komiser_linux_amd64 s3://komiser-releases/3.0.0/linux/komiser --grants read=uri=http://acs.amazonaws.com/groups/global/AllUsers
      - run:
          name: Push Windows binary
          command: aws s3 cp komiser_windows_amd64.exe s3://komiser-releases/3.0.0/windows/komiser --grants read=uri=http://acs.amazonaws.com/groups/global/AllUsers
      - run:
          name: Push Mac OS X binary
          command: aws s3 cp komiser_darwin_amd64 s3://komiser-releases/3.0.0/osx/komiser --grants read=uri=http://acs.amazonaws.com/groups/global/AllUsers
      - run:
          name: Upload IAM policy
          command: aws s3 cp policy.json s3://komiser-releases/policy.json --grants read=uri=http://acs.amazonaws.com/groups/global/AllUsers

  build_docker:
    docker:
       - image: docker:20.10.6
    resource_class: large
    steps:
        - checkout
        - setup_remote_docker
        - run:
            name: Build Komiser Docker Image
            command: docker build -t mlabouardy/komiser:latest .
        - deploy:
            name: Push Komiser to DockerHub
            command: |
              docker login -u$DOCKERHUB_LOGIN -p$DOCKERHUB_PASSWORD
              docker tag mlabouardy/komiser:latest mlabouardy/komiser:${CIRCLE_SHA1}
              docker tag mlabouardy/komiser:latest mlabouardy/komiser:3.0.0
              docker push mlabouardy/komiser:latest
              docker push mlabouardy/komiser:3.0.0
              docker push mlabouardy/komiser:${CIRCLE_SHA1}
      
workflows:
    version: 2
    build_and_deploy:
        jobs:
            - build_frontend:
                filters:
                    branches:
                        only:
                        - master
                        - v3.0.0
            - build_cli:
                requires:
                    - build_frontend
                filters:
                    branches:
                        only:
                        - master
                        - v3.0.0
            - build_docker:
                requires:
                    - build_cli
                filters:
                    branches:
                        only:
                        - master
                        - v3.0.0